# 部署脚本说明

本目录包含用于部署和管理 OKR 绩效考核系统的自动化脚本。

## 脚本列表

### 1. update.sh - 项目更新脚本

用于更新线上项目到最新版本。

**功能特性:**
- 自动备份当前版本
- 拉取最新代码
- 保存和恢复本地配置（如 .env.local）
- 重新安装依赖和构建项目
- 重启 PM2 服务
- 验证部署状态

**使用方法:**
```bash
# 进入项目根目录
cd /www/wwwroot/okr.gerenukagro.com

# 执行更新
./sh/update.sh
```

**备份位置:**
- 备份目录：`/www/backup/okr-YYYYMMDD_HHMMSS/`
- 包含：`.next/`、`.env.local`、`package.json` 等关键文件

### 2. rollback.sh - 项目回滚脚本

用于将项目回滚到指定的备份版本。

**功能特性:**
- 从指定备份恢复项目
- 安全确认机制
- 自动备份当前状态（回滚前）
- 检查依赖版本兼容性
- 重启服务并验证状态

**使用方法:**
```bash
# 查看可用备份
./sh/rollback.sh

# 回滚到指定版本
./sh/rollback.sh /www/backup/okr-20250717_103045
```

## 部署流程

### 日常更新流程
1. 开发完成后，推送代码到 GitHub
2. 在服务器上执行：`./sh/update.sh`
3. 验证服务是否正常运行

### 回滚流程
1. 如果更新后发现问题
2. 执行：`./sh/rollback.sh <备份目录>`
3. 验证回滚是否成功

## 注意事项

### 环境变量处理
- 脚本会自动保存和恢复 `.env.local` 文件
- 修改环境变量后需要重新构建才能生效
- 使用 `NEXT_PUBLIC_` 前缀的变量才能在客户端访问

### 备份管理
- 建议定期清理旧备份文件，保留最近 10-20 个版本
- 重要版本可以手动备份到其他位置

### 权限要求
- 脚本需要执行权限：`chmod +x sh/*.sh`
- 需要 PM2 管理权限
- 需要项目目录的读写权限

### 依赖要求
- Node.js 18+
- npm 或 yarn
- PM2 进程管理器
- Git 版本控制

## 故障排除

### 常见问题
1. **权限错误**：检查脚本执行权限和目录权限
2. **PM2 服务未找到**：确认服务名称为 `okr-frontend`
3. **构建失败**：检查 Node.js 版本和依赖兼容性
4. **端口冲突**：确认端口 3020 未被占用

### 调试命令
```bash
# 查看 PM2 服务状态
pm2 status

# 查看服务日志
pm2 logs okr-frontend

# 查看 Nginx 状态
nginx -t

# 检查端口占用
netstat -tlnp | grep 3020
```

## 安全建议

1. **定期备份**：除自动备份外，重要版本手动备份
2. **测试环境**：重要更新先在测试环境验证
3. **监控告警**：配置服务监控和告警机制
4. **日志管理**：定期清理和分析日志文件